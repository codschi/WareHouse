{% extends "base.html" %}

{% block title %}領料單管理 - 物流倉儲管理系統{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-dolly me-2"></i>領料單管理</h2>
    <a href="/requisitions/add" class="btn btn-success">
        <i class="fas fa-plus me-1"></i> 新增領料
    </a>
</div>

<div class="mb-3">
    <div class="input-group">
        <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
        <input type="text" id="searchInput" class="form-control" placeholder="輸入關鍵字搜尋 (例如：單號、原因...)">
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="table-dark">
                <tr>
                    <th>單號 (ID)</th>
                    <th>領料日期</th>
                    <th>領料原因</th>
                    <th>明細</th>
                    <th>經手員工</th>
                    <th class="text-end pe-4">操作</th>
                </tr>
            </thead>

            <tbody id="myTable">
                {% for req in req_list %}
                <tr>
                    <td>{{ req.ReqID }}</td>
                    <td class="fw-bold">{{ req.reDate }}</td>
                    <td>{{ req.reReason }}</td>

                    <td>
                        <span class="badge bg-secondary me-2">{{ req.details|length }} 筆項目</span>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#detailModal" onclick="showDetails({{ req.details|tojson|safe }})">
                            <i class="fas fa-eye"></i> 查看
                        </button>
                    </td>

                    <td>{{ req.staff.stName if req.staff else req.StaffID }}</td>
                    <td class="text-end pe-3">
                        <form action="/requisitions/delete/{{ req.ReqID }}" method="POST" class="d-inline"
                            onsubmit="return confirm('刪除此單將一併刪除其所有明細，確定嗎？');">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr class="no-data">
                    <td colspan="6" class="text-center py-5 text-muted">目前沒有領料紀錄</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-list-alt me-2"></i>領料單明細</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>商品名稱 (ID)</th>
                            <th>領取數量</th>
                            <th>出庫倉庫</th>
                        </tr>
                    </thead>
                    <tbody id="modalBodyContent">
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 搜尋功能
    document.getElementById("searchInput").addEventListener("keyup", function () {
        var value = this.value.toLowerCase();
        var rows = document.querySelectorAll("#myTable tr");

        rows.forEach(function (row) {
            if (row.classList.contains('no-data')) return;
            var text = row.innerText.toLowerCase();
            if (text.indexOf(value) > -1) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    });

    // 顯示 Modal 功能
    function showDetails(details) {
        const tbody = document.getElementById('modalBodyContent');
        tbody.innerHTML = '';

        if (!details || details.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center">無明細資料</td></tr>';
            return;
        }

        details.forEach(item => {
            const prodName = item.product ? item.product.prName : '未知商品';
            const prodId = item.ProductID;
            const qty = item.rdQuantity; // 注意：這裡是 rdQuantity
            const waName = item.warehouse ? item.warehouse.waName : '未知倉庫';

            const row = `
                <tr>
                    <td>${prodName} <span class="text-muted small">(${prodId})</span></td>
                    <td class="fw-bold text-danger">${qty}</td>
                    <td>${waName}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }
</script>
{% endblock %}